<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Ruby on Rails on ECS #fukuokark02</title><link rel="stylesheet" href="css/reveal.min.css"><link rel="stylesheet" href="css/theme/white.css"><link rel="stylesheet" href="lib/css/zenburn.css"><link rel="stylesheet" href="css/font-awesome.min.css"><link rel="stylesheet" href="css/my.css"><script>var link = document.createElement( 'link' );
link.rel = 'stylesheet';
link.type = 'text/css';
link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
document.getElementsByTagName( 'head' )[0].appendChild( link );</script><script async="" src="//platform.twitter.com/widgets.js" charset="utf-8"></script></head><body><div class="reveal"><div class="slides"><section><h1>Ruby on Rails on ECS</h1><p>2017-11-24</p><p>福岡Ruby会議02・前夜祭</p><p>うなすけ</p></section><section><h2>connpass</h2><img src="img/connpass-long-title.png"><small><a href="https://fukuokarb.connpass.com/event/68497/">https://fukuokarb.connpass.com/event/68497/</a></small><p>タイトル長過ぎました 🙇</p></section><section><p>新規RailsアプリをECSで運用したときの知見や、<br>現行のRailsアプリをDocker化するときに遭遇した課題などについて</p><p>改め</p><h2>Ruby on Rails on ECS</h2><img src="img/connpass-atnd.png"></section><section><h2>自己紹介</h2><div class="flex-container"><div class="item-40"><img src="img/icon_raw.jpg" alt="icon"></div><div class="item-60"><ul><li>名前: うなすけ</li><li>株式会社spice life</li><li>インフラリードエンジニア</li><br><li>twitter&nbsp;<i class="fa fa-twitter"></i>:&nbsp;<a href="https://twitter.com/yu_suke1994">@yu_suke1994</a></li><li>GitHub&nbsp;<i class="fa fa-github"></i>:&nbsp;<a href="https://github.com/unasuke">@unasuke</a></li></ul></div></div></section><section><h2>spice life</h2><div class="flex-container"><div class="item-50"><h3>TMIX</h3><img src="img/tmix-lp.png" alt="TMIX"></div><div class="item-50"><h3>STEERS</h3><img src="img/steers-lp.png" alt="STEERS"></div></div></section><section><h2>もくじ</h2><ol><li>新規Railsアプリとは ⬅️⬅️⬅️</li><li>まずはDocker化</li><li>ECSで動かす</li><li>ハマったところ</li><li>既存のRailsのESC化のハードル</li><li>まとめ</li></ol></section><section><h2>新規Railsアプリ</h2><dl><dt>rails new</dt><dd>2017-04-10</dd><dt>用途</dt><dd>大口注文の社内管理用</dd></dl><p>Docker(ECS)化するにはもってこいだった</p></section><section><h2>もくじ</h2><ol><li>新規Railsアプリとは</li><li>まずはDocker化 ⬅️⬅️⬅️</li><li>ECSで動かす</li><li>ハマったところ</li><li>既存のRailsのESC化のハードル</li><li>まとめ</li></ol></section><section><h2>まずはDocker化</h2><p>なんだかんだ環境ごとにDockerfileはわかれちゃう</p><pre><code>app
config
db
docker/
  └ app-base/
      └ Dockerfile        # apt packages
  └ app-development/
      └ Dockerfile        # gem group :development
  └ app-production/
      └ Dockerfile        # gem group :production</code></pre></section><section><h2>まずはDocker化</h2><h3>asset precompile</h3><p>Q. assetどこに置く問題</p><ul><li>S3などのオブジェクトストレージ</li><li>コンテナの中</li></ul></section><section><h2>まずはDocker化</h2><h3>asset precompile</h3><h4>asset置き場</h4><dl><dt>オブジェクトストレージ</dt><dd>コンテナイメージが軽くなる</dd><dt>コンテナの中</dt><dd>お手軽</dd></dl></section><section><h2>まずはDocker化</h2><h3>asset precompile</h3><h4>asset置き場</h4><p>コンテナの中に置くことにした</p><p>CDN → nginx → container</p><small>参考:<a href="http://r7kamura.hatenablog.com/entry/2016/12/26/041931">amakanの本番環境をDockerに移行した - ✘╹◡╹✘</a></small></section><section><h2>まずはDocker化</h2><h3>assets in container</h3><p>asset配信用ドメイン(CDN)以外からの<br>assetへのアクセスを弾きたい</p></section><section><h2>まずはDocker化</h2><h3>assets in container</h3><p>nginx.confで制御</p><table><thead><tr><th>path</th><th>asset.example.com</th><th>example.com</th></tr></thead><tbody><tr><td><code>/asset/*</code></td><td>200</td><td>200</td></tr><tr><td><code>/</code></td><td>404</td><td>200</td></tr></tbody></table></section><section><h2>もくじ</h2><ol><li>新規Railsアプリとは</li><li>まずはDocker化</li><li>ECSで動かす ⬅️⬅️⬅️</li><li>ハマったところ</li><li>既存のRailsのESC化のハードル</li><li>まとめ</li></ol></section><section><h2>ECSで動かす</h2><h3>Docker imageのbuild/push</h3><p>なるべく速くすませたい</p></section><section><h2>ECSで動かす</h2><h3>Docker imageのbuild/push</h3><h4>検証したCI Service</h4><ul><li>Circle CI</li><li>Travis CI</li><li>Codeship</li><li>Codefresh</li><li>Drone.io</li></ul></section><section><h2>ECSで動かす</h2><h3>Docker imageのbuild/push</h3><h4>Drone.ioを選択</h4><ul><li>😄 Docker layer cache</li><li>😄 Fast push to ECR (オンプレなので)</li><li>😄 Fast build (c4.large)</li><li>😣 オンプレミス</li><li>🤔 OSS</li></ul></section><section><h2>ECSで動かす</h2><h3>Deploy</h3><ul><li>Service / Task Definition を一元管理したい</li><li>環境を問わずデプロイできるようにする</li><li>revisionをカッチリ指定したい</li></ul></section><section><h2>ECSで動かす</h2><h3>Deploy</h3><h4>unasuke/mikoshi</h4><p><a href="https://github.com/unasuke/mikoshi/">https://github.com/unasuke/mikoshi/</a></p><p>Service / Task DefinitionをYaml(ERB)で管理する</p><p>定義を含むDocker imageを作成してpull/deploy</p></section><section><h2>ECSで動かす</h2><h3>Deploy</h3><h4>unasuke/mikoshi</h4><pre><code class="lang-yaml"># task_definitions/ping2googledns.yml.erb
task_definition:
  family: "ping2googledns"
  network_mode: "bridge"
  container_definitions:
    - name: "ping"
      image: "unasuke/ping2googledns:latest"
      cpu: 128
      memory: 128
hooks:
  after_register:
    - echo registerd</code></pre></section><section><h2>ECSで動かす</h2><h3>Deploy</h3><h4>unasuke/mikoshi</h4><p>deploy command in CI job</p><pre><code>docker run --rm --tty \
  -e IMAGE_REVISION=${DRONE_COMMIT_SHA} \
  -e AWS_REGION=${AWS_DEFAULT_REGION} \
  ${ECR_HOST}/mikoshi-container:latest deploy -g app-name</code></pre></section><section><h2>もくじ</h2><ol><li>新規Railsアプリとは</li><li>まずはDocker化</li><li>ECSで動かす</li><li>ハマったところ  ⬅️⬅️⬅️</li><li>既存のRailsのESC化のハードル</li><li>まとめ</li></ol></section><section><h2>ハマったところ</h2><h3>db:migrate → SIGTERM</h3><p>ECS RunTaskでのdb:migrateがSIGTERM</p></section><section><h2>ハマったところ</h2><h3>db:migrate → SIGTERM</h3><h4>原因</h4><p>nginxにtrueを渡して落としていたのが<br>つられてRailsも落ちる 😨</p></section><section><h2>ハマったところ</h2><h3>db:migrate → SIGTERM</h3><h4>workaround</h4><p>Railsのみを含むTask Definitionを作成して<br>それを使いdb:migrate</p><p class="fragment">🤔🤔🤔🤔🤔🤔🤔🤔🤔🤔</p></section><section><h2>ハマったところ</h2><h3>db:migrate → SIGTERM</h3><h4>例えばnginxをやめる！！！！！</h4></section><section><h2>ハマったところ</h2><h3>db:migrate → SIGTERM</h3><h4>nginxの役割</h4><ul><li>Basic Auth<ul><li>Railsでもできる！</li></ul></li><li>httpsへのredirect<ul><li>Railsでもできる！</li></ul></li><li>asset配信のドメイン制御<ul><li>Railsでも……？</li></ul></li></ul></section><section><h2>ハマったところ</h2><h3>db:migrate → SIGTERM</h3><h4>asset配信のドメイン制御をRackで</h4><p>Rack middlewareでやっちゃえばいいんじゃ？！</p><ul><li><a href="https://github.com/udzura/rack-block">https://github.com/udzura/rack-block</a></li><li><a href="https://github.com/kickstarter/rack-attack">https://github.com/kickstarter/rack-attack</a></li><ul><li>こっちを採用</li></ul></ul></section><section><h2>ハマったところ</h2><h3>db:migrate → SIGTERM</h3><h4>asset配信のドメイン制御をRackで</h4><p>Rack middlewareでやっちゃえばいいんじゃ？！</p><img src="img/tweet-yu_suke-1994-933349862862594048.png" width="45%"><small>回収&nbsp;<a href="https://twitter.com/yu_suke1994/status/933349862862594048">https://twitter.com/yu_suke1994/status/933349862862594048</a></small></section><section><h2>ハマったところ</h2><ul><li>logどうやって見るの</li><li>rails consoleしたいんだけど</li></ul><p>時間ないんで省略 🏃💨</p></section><section><h2>もくじ</h2><ol><li>新規Railsアプリとは</li><li>まずはDocker化</li><li>ECSで動かす</li><li>ハマったところ</li><li>既存のRailsのESC化のハードル ⬅️⬅️⬅️</li><li>まとめ</li></ol></section><section><h2>既存のRailsのESC化のハードル</h2><p>既存のRailsっていうのはTMIXのことです</p><small>あなたとJAVA</small></section><section><h2>TMIXのESC化のハードル</h2><ul><li>ridgepole</li><ul><li>apply</li><li>test</li></ul></ul></section><section><h2>TMIXのESC化のハードル</h2><h3>ridgepole</h3><p>TMIXは1DB、複数App<br>ridgepoleでschema管理</p><a href="https://github.com/winebarrel/ridgepole">https://github.com/winebarrel/ridgepole</a></section><section><h2>TMIXのESC化のハードル</h2><h3>ridgepole</h3><h4>applyをどうやっていたか</h4><p>ridgepole applyはとあるRailsアプリの<br>インスタンスからcapで行なっていた</p><p>⬆️</p><p>コンテナ化するとなると……？</p></section><section><h2>TMIXのESC化のハードル</h2><h3>ridgepole</h3><h4>applyをどうするか</h4><p>ECS RunTaskで行なう(Done!)</p><small>このためにmikoshiがRunTaskに対応した</small></section><section><h2>TMIXのESC化のハードル</h2><h3>test</h3><p>CIでspecを実行するときに<br>いちいちridgepole applyしている……</p><p>⬆️</p><p>schema適用済のDB containerを用意できないか？</p><small>手がつけられていない……</small></section><section><h2>TMIXのESC化のハードル</h2><h3>「やっていき」の気持ち 💪</h3></section><section><h2>もくじ</h2><ol><li>新規Railsアプリとは</li><li>まずはDocker化</li><li>ECSで動かす</li><li>ハマったところ</li><li>既存のRailsのESC化のハードル</li><li>まとめ ⬅️⬅️⬅️</li></ol></section><section><h2>まとめ</h2><ul><li>ECSで動かすよりも、その前準備が大変</li><ul><li>CI、deploy、構成etc……</li></ul><li>社内アプリから導入したのは良かった</li><ul><li>営業時間外のダウンタイムに寛容</li></ul><li>勢いも大事</li><ul><li>「Dockerやっていくぞ！！！」</li></ul></ul><br><small><p>もっと詳しく</p><ul><li><a href="http://blog.spicelife.jp/entry/2017/07/06/140349">RailsアプリをECSで運用するまでにやったこと、これからしていくこと</a></li><li><a href="http://blog.spicelife.jp/entry/2017/09/05/183605">ridgepoleのapplyをECS RunTaskで実行するようにしました</a></li></ul></small></section><section><h1 class="biggest">やれば<br>できる</h1></section></div></div><script src="lib/js/head.min.js"></script><script src="js/reveal.min.js"></script><script>// More info https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({
  history: true,
  transition: 'none',
  backgroundTransition: 'none',
  // More info https://github.com/hakimel/reveal.js#dependencies
  dependencies: [
    { src: 'plugin/markdown/marked.js' },
    { src: 'plugin/markdown/markdown.js' },
    { src: 'plugin/notes/notes.js', async: true },
    { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
  ]
});</script></body></html>