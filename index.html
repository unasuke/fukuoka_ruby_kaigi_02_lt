<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>Ruby on Rails on ECS #fukuokark02</title><link rel="stylesheet" href="css/reveal.min.css"><link rel="stylesheet" href="css/theme/white.css"><link rel="stylesheet" href="lib/css/zenburn.css"><link rel="stylesheet" href="css/font-awesome.min.css"><link rel="stylesheet" href="css/my.css"><script>var link = document.createElement( 'link' );
link.rel = 'stylesheet';
link.type = 'text/css';
link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
document.getElementsByTagName( 'head' )[0].appendChild( link );</script><script async="" src="//platform.twitter.com/widgets.js" charset="utf-8"></script></head><body><div class="reveal"><div class="slides"><section><h1>Ruby on Rails on ECS</h1><p>2017-11-24</p><p>ç¦å²¡Rubyä¼šè­°02ãƒ»å‰å¤œç¥­</p><p>ã†ãªã™ã‘</p></section><section><h2>connpass</h2><img src="img/connpass-long-title.png"><small><a href="https://fukuokarb.connpass.com/event/68497/">https://fukuokarb.connpass.com/event/68497/</a></small><p>ã‚¿ã‚¤ãƒˆãƒ«é•·éãã¾ã—ãŸ ğŸ™‡</p></section><section><p>æ–°è¦Railsã‚¢ãƒ—ãƒªã‚’ECSã§é‹ç”¨ã—ãŸã¨ãã®çŸ¥è¦‹ã‚„ã€<br>ç¾è¡Œã®Railsã‚¢ãƒ—ãƒªã‚’DockeråŒ–ã™ã‚‹ã¨ãã«é­é‡ã—ãŸèª²é¡Œãªã©ã«ã¤ã„ã¦</p><p>æ”¹ã‚</p><h2>Ruby on Rails on ECS</h2><img src="img/connpass-atnd.png"></section><section><h2>è‡ªå·±ç´¹ä»‹</h2><div class="flex-container"><div class="item-40"><img src="img/icon_raw.jpg" alt="icon"></div><div class="item-60"><ul><li>åå‰: ã†ãªã™ã‘</li><li>æ ªå¼ä¼šç¤¾spice life</li><li>ã‚¤ãƒ³ãƒ•ãƒ©ãƒªãƒ¼ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢</li><br><li>twitter&nbsp;<i class="fa fa-twitter"></i>:&nbsp;<a href="https://twitter.com/yu_suke1994">@yu_suke1994</a></li><li>GitHub&nbsp;<i class="fa fa-github"></i>:&nbsp;<a href="https://github.com/unasuke">@unasuke</a></li></ul></div></div></section><section><h2>spice life</h2><div class="flex-container"><div class="item-50"><h3>TMIX</h3><img src="img/tmix-lp.png" alt="TMIX"></div><div class="item-50"><h3>STEERS</h3><img src="img/steers-lp.png" alt="STEERS"></div></div></section><section><h2>ã‚‚ãã˜</h2><ol><li>æ–°è¦Railsã‚¢ãƒ—ãƒªã¨ã¯ â¬…ï¸â¬…ï¸â¬…ï¸</li><li>ã¾ãšã¯DockeråŒ–</li><li>ECSã§å‹•ã‹ã™</li><li>ãƒãƒã£ãŸã¨ã“ã‚</li><li>æ—¢å­˜ã®Railsã®ESCåŒ–ã®ãƒãƒ¼ãƒ‰ãƒ«</li><li>ã¾ã¨ã‚</li></ol></section><section><h2>æ–°è¦Railsã‚¢ãƒ—ãƒª</h2><dl><dt>rails new</dt><dd>2017-04-10</dd><dt>ç”¨é€”</dt><dd>å¤§å£æ³¨æ–‡ã®ç¤¾å†…ç®¡ç†ç”¨</dd></dl><p>Docker(ECS)åŒ–ã™ã‚‹ã«ã¯ã‚‚ã£ã¦ã“ã„ã ã£ãŸ</p></section><section><h2>ã‚‚ãã˜</h2><ol><li>æ–°è¦Railsã‚¢ãƒ—ãƒªã¨ã¯</li><li>ã¾ãšã¯DockeråŒ– â¬…ï¸â¬…ï¸â¬…ï¸</li><li>ECSã§å‹•ã‹ã™</li><li>ãƒãƒã£ãŸã¨ã“ã‚</li><li>æ—¢å­˜ã®Railsã®ESCåŒ–ã®ãƒãƒ¼ãƒ‰ãƒ«</li><li>ã¾ã¨ã‚</li></ol></section><section><h2>ã¾ãšã¯DockeråŒ–</h2><p>ãªã‚“ã ã‹ã‚“ã ç’°å¢ƒã”ã¨ã«Dockerfileã¯ã‚ã‹ã‚Œã¡ã‚ƒã†</p><pre><code>app
config
db
docker/
  â”” app-base/
      â”” Dockerfile        # apt packages
  â”” app-development/
      â”” Dockerfile        # gem group :development
  â”” app-production/
      â”” Dockerfile        # gem group :production</code></pre></section><section><h2>ã¾ãšã¯DockeråŒ–</h2><h3>asset precompile</h3><p>Q. assetã©ã“ã«ç½®ãå•é¡Œ</p><ul><li>S3ãªã©ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸</li><li>ã‚³ãƒ³ãƒ†ãƒŠã®ä¸­</li></ul></section><section><h2>ã¾ãšã¯DockeråŒ–</h2><h3>asset precompile</h3><h4>assetç½®ãå ´</h4><dl><dt>ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸</dt><dd>ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ãŒè»½ããªã‚‹</dd><dt>ã‚³ãƒ³ãƒ†ãƒŠã®ä¸­</dt><dd>ãŠæ‰‹è»½</dd></dl></section><section><h2>ã¾ãšã¯DockeråŒ–</h2><h3>asset precompile</h3><h4>assetç½®ãå ´</h4><p>ã‚³ãƒ³ãƒ†ãƒŠã®ä¸­ã«ç½®ãã“ã¨ã«ã—ãŸ</p><p>CDN â†’ nginx â†’ container</p><small>å‚è€ƒ:<a href="http://r7kamura.hatenablog.com/entry/2016/12/26/041931">amakanã®æœ¬ç•ªç’°å¢ƒã‚’Dockerã«ç§»è¡Œã—ãŸ - âœ˜â•¹â—¡â•¹âœ˜</a></small></section><section><h2>ã¾ãšã¯DockeråŒ–</h2><h3>assets in container</h3><p>asseté…ä¿¡ç”¨ãƒ‰ãƒ¡ã‚¤ãƒ³(CDN)ä»¥å¤–ã‹ã‚‰ã®<br>assetã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’å¼¾ããŸã„</p></section><section><h2>ã¾ãšã¯DockeråŒ–</h2><h3>assets in container</h3><p>nginx.confã§åˆ¶å¾¡</p><table><thead><tr><th>path</th><th>asset.example.com</th><th>example.com</th></tr></thead><tbody><tr><td><code>/asset/*</code></td><td>200</td><td>200</td></tr><tr><td><code>/</code></td><td>404</td><td>200</td></tr></tbody></table></section><section><h2>ã‚‚ãã˜</h2><ol><li>æ–°è¦Railsã‚¢ãƒ—ãƒªã¨ã¯</li><li>ã¾ãšã¯DockeråŒ–</li><li>ECSã§å‹•ã‹ã™ â¬…ï¸â¬…ï¸â¬…ï¸</li><li>ãƒãƒã£ãŸã¨ã“ã‚</li><li>æ—¢å­˜ã®Railsã®ESCåŒ–ã®ãƒãƒ¼ãƒ‰ãƒ«</li><li>ã¾ã¨ã‚</li></ol></section><section><h2>ECSã§å‹•ã‹ã™</h2><h3>Docker imageã®build/push</h3><p>ãªã‚‹ã¹ãé€Ÿãã™ã¾ã›ãŸã„</p></section><section><h2>ECSã§å‹•ã‹ã™</h2><h3>Docker imageã®build/push</h3><h4>æ¤œè¨¼ã—ãŸCI Service</h4><ul><li>Circle CI</li><li>Travis CI</li><li>Codeship</li><li>Codefresh</li><li>Drone.io</li></ul></section><section><h2>ECSã§å‹•ã‹ã™</h2><h3>Docker imageã®build/push</h3><h4>Drone.ioã‚’é¸æŠ</h4><ul><li>ğŸ˜„ Docker layer cache</li><li>ğŸ˜„ Fast push to ECR (ã‚ªãƒ³ãƒ—ãƒ¬ãªã®ã§)</li><li>ğŸ˜„ Fast build (c4.large)</li><li>ğŸ˜£ ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹</li><li>ğŸ¤” OSS</li></ul></section><section><h2>ECSã§å‹•ã‹ã™</h2><h3>Deploy</h3><ul><li>Service / Task Definition ã‚’ä¸€å…ƒç®¡ç†ã—ãŸã„</li><li>ç’°å¢ƒã‚’å•ã‚ãšãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹</li><li>revisionã‚’ã‚«ãƒƒãƒãƒªæŒ‡å®šã—ãŸã„</li></ul></section><section><h2>ECSã§å‹•ã‹ã™</h2><h3>Deploy</h3><h4>unasuke/mikoshi</h4><p><a href="https://github.com/unasuke/mikoshi/">https://github.com/unasuke/mikoshi/</a></p><p>Service / Task Definitionã‚’Yaml(ERB)ã§ç®¡ç†ã™ã‚‹</p><p>å®šç¾©ã‚’å«ã‚€Docker imageã‚’ä½œæˆã—ã¦pull/deploy</p></section><section><h2>ECSã§å‹•ã‹ã™</h2><h3>Deploy</h3><h4>unasuke/mikoshi</h4><pre><code class="lang-yaml"># task_definitions/ping2googledns.yml.erb
task_definition:
  family: "ping2googledns"
  network_mode: "bridge"
  container_definitions:
    - name: "ping"
      image: "unasuke/ping2googledns:latest"
      cpu: 128
      memory: 128
hooks:
  after_register:
    - echo registerd</code></pre></section><section><h2>ECSã§å‹•ã‹ã™</h2><h3>Deploy</h3><h4>unasuke/mikoshi</h4><p>deploy command in CI job</p><pre><code>docker run --rm --tty \
  -e IMAGE_REVISION=${DRONE_COMMIT_SHA} \
  -e AWS_REGION=${AWS_DEFAULT_REGION} \
  ${ECR_HOST}/mikoshi-container:latest deploy -g app-name</code></pre></section><section><h2>ã‚‚ãã˜</h2><ol><li>æ–°è¦Railsã‚¢ãƒ—ãƒªã¨ã¯</li><li>ã¾ãšã¯DockeråŒ–</li><li>ECSã§å‹•ã‹ã™</li><li>ãƒãƒã£ãŸã¨ã“ã‚  â¬…ï¸â¬…ï¸â¬…ï¸</li><li>æ—¢å­˜ã®Railsã®ESCåŒ–ã®ãƒãƒ¼ãƒ‰ãƒ«</li><li>ã¾ã¨ã‚</li></ol></section><section><h2>ãƒãƒã£ãŸã¨ã“ã‚</h2><h3>db:migrate â†’ SIGTERM</h3><p>ECS RunTaskã§ã®db:migrateãŒSIGTERM</p></section><section><h2>ãƒãƒã£ãŸã¨ã“ã‚</h2><h3>db:migrate â†’ SIGTERM</h3><h4>åŸå› </h4><p>nginxã«trueã‚’æ¸¡ã—ã¦è½ã¨ã—ã¦ã„ãŸã®ãŒ<br>ã¤ã‚‰ã‚Œã¦Railsã‚‚è½ã¡ã‚‹ ğŸ˜¨</p></section><section><h2>ãƒãƒã£ãŸã¨ã“ã‚</h2><h3>db:migrate â†’ SIGTERM</h3><h4>workaround</h4><p>Railsã®ã¿ã‚’å«ã‚€Task Definitionã‚’ä½œæˆã—ã¦<br>ãã‚Œã‚’ä½¿ã„db:migrate</p><p class="fragment">ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”</p></section><section><h2>ãƒãƒã£ãŸã¨ã“ã‚</h2><h3>db:migrate â†’ SIGTERM</h3><h4>ä¾‹ãˆã°nginxã‚’ã‚„ã‚ã‚‹ï¼ï¼ï¼ï¼ï¼</h4></section><section><h2>ãƒãƒã£ãŸã¨ã“ã‚</h2><h3>db:migrate â†’ SIGTERM</h3><h4>nginxã®å½¹å‰²</h4><ul><li>Basic Auth<ul><li>Railsã§ã‚‚ã§ãã‚‹ï¼</li></ul></li><li>httpsã¸ã®redirect<ul><li>Railsã§ã‚‚ã§ãã‚‹ï¼</li></ul></li><li>asseté…ä¿¡ã®ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ¶å¾¡<ul><li>Railsã§ã‚‚â€¦â€¦ï¼Ÿ</li></ul></li></ul></section><section><h2>ãƒãƒã£ãŸã¨ã“ã‚</h2><h3>db:migrate â†’ SIGTERM</h3><h4>asseté…ä¿¡ã®ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ¶å¾¡ã‚’Rackã§</h4><p>Rack middlewareã§ã‚„ã£ã¡ã‚ƒãˆã°ã„ã„ã‚“ã˜ã‚ƒï¼Ÿï¼</p><ul><li><a href="https://github.com/udzura/rack-block">https://github.com/udzura/rack-block</a></li><li><a href="https://github.com/kickstarter/rack-attack">https://github.com/kickstarter/rack-attack</a></li><ul><li>ã“ã£ã¡ã‚’æ¡ç”¨</li></ul></ul></section><section><h2>ãƒãƒã£ãŸã¨ã“ã‚</h2><h3>db:migrate â†’ SIGTERM</h3><h4>asseté…ä¿¡ã®ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ¶å¾¡ã‚’Rackã§</h4><p>Rack middlewareã§ã‚„ã£ã¡ã‚ƒãˆã°ã„ã„ã‚“ã˜ã‚ƒï¼Ÿï¼</p><img src="img/tweet-yu_suke-1994-933349862862594048.png" width="45%"><small>å›å&nbsp;<a href="https://twitter.com/yu_suke1994/status/933349862862594048">https://twitter.com/yu_suke1994/status/933349862862594048</a></small></section><section><h2>ãƒãƒã£ãŸã¨ã“ã‚</h2><ul><li>logã©ã†ã‚„ã£ã¦è¦‹ã‚‹ã®</li><li>rails consoleã—ãŸã„ã‚“ã ã‘ã©</li></ul><p>æ™‚é–“ãªã„ã‚“ã§çœç•¥ ğŸƒğŸ’¨</p></section><section><h2>ã‚‚ãã˜</h2><ol><li>æ–°è¦Railsã‚¢ãƒ—ãƒªã¨ã¯</li><li>ã¾ãšã¯DockeråŒ–</li><li>ECSã§å‹•ã‹ã™</li><li>ãƒãƒã£ãŸã¨ã“ã‚</li><li>æ—¢å­˜ã®Railsã®ESCåŒ–ã®ãƒãƒ¼ãƒ‰ãƒ« â¬…ï¸â¬…ï¸â¬…ï¸</li><li>ã¾ã¨ã‚</li></ol></section><section><h2>æ—¢å­˜ã®Railsã®ESCåŒ–ã®ãƒãƒ¼ãƒ‰ãƒ«</h2><p>æ—¢å­˜ã®Railsã£ã¦ã„ã†ã®ã¯TMIXã®ã“ã¨ã§ã™</p><small>ã‚ãªãŸã¨JAVA</small></section><section><h2>TMIXã®ESCåŒ–ã®ãƒãƒ¼ãƒ‰ãƒ«</h2><ul><li>ridgepole</li><ul><li>apply</li><li>test</li></ul></ul></section><section><h2>TMIXã®ESCåŒ–ã®ãƒãƒ¼ãƒ‰ãƒ«</h2><h3>ridgepole</h3><p>TMIXã¯1DBã€è¤‡æ•°App<br>ridgepoleã§schemaç®¡ç†</p><a href="https://github.com/winebarrel/ridgepole">https://github.com/winebarrel/ridgepole</a></section><section><h2>TMIXã®ESCåŒ–ã®ãƒãƒ¼ãƒ‰ãƒ«</h2><h3>ridgepole</h3><h4>applyã‚’ã©ã†ã‚„ã£ã¦ã„ãŸã‹</h4><p>ridgepole applyã¯ã¨ã‚ã‚‹Railsã‚¢ãƒ—ãƒªã®<br>ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‹ã‚‰capã§è¡Œãªã£ã¦ã„ãŸ</p><p>â¬†ï¸</p><p>ã‚³ãƒ³ãƒ†ãƒŠåŒ–ã™ã‚‹ã¨ãªã‚‹ã¨â€¦â€¦ï¼Ÿ</p></section><section><h2>TMIXã®ESCåŒ–ã®ãƒãƒ¼ãƒ‰ãƒ«</h2><h3>ridgepole</h3><h4>applyã‚’ã©ã†ã™ã‚‹ã‹</h4><p>ECS RunTaskã§è¡Œãªã†(Done!)</p><small>ã“ã®ãŸã‚ã«mikoshiãŒRunTaskã«å¯¾å¿œã—ãŸ</small></section><section><h2>TMIXã®ESCåŒ–ã®ãƒãƒ¼ãƒ‰ãƒ«</h2><h3>test</h3><p>CIã§specã‚’å®Ÿè¡Œã™ã‚‹ã¨ãã«<br>ã„ã¡ã„ã¡ridgepole applyã—ã¦ã„ã‚‹â€¦â€¦</p><p>â¬†ï¸</p><p>schemaé©ç”¨æ¸ˆã®DB containerã‚’ç”¨æ„ã§ããªã„ã‹ï¼Ÿ</p><small>æ‰‹ãŒã¤ã‘ã‚‰ã‚Œã¦ã„ãªã„â€¦â€¦</small></section><section><h2>TMIXã®ESCåŒ–ã®ãƒãƒ¼ãƒ‰ãƒ«</h2><h3>ã€Œã‚„ã£ã¦ã„ãã€ã®æ°—æŒã¡ ğŸ’ª</h3></section><section><h2>ã‚‚ãã˜</h2><ol><li>æ–°è¦Railsã‚¢ãƒ—ãƒªã¨ã¯</li><li>ã¾ãšã¯DockeråŒ–</li><li>ECSã§å‹•ã‹ã™</li><li>ãƒãƒã£ãŸã¨ã“ã‚</li><li>æ—¢å­˜ã®Railsã®ESCåŒ–ã®ãƒãƒ¼ãƒ‰ãƒ«</li><li>ã¾ã¨ã‚ â¬…ï¸â¬…ï¸â¬…ï¸</li></ol></section><section><h2>ã¾ã¨ã‚</h2><ul><li>ECSã§å‹•ã‹ã™ã‚ˆã‚Šã‚‚ã€ãã®å‰æº–å‚™ãŒå¤§å¤‰</li><ul><li>CIã€deployã€æ§‹æˆetcâ€¦â€¦</li></ul><li>ç¤¾å†…ã‚¢ãƒ—ãƒªã‹ã‚‰å°å…¥ã—ãŸã®ã¯è‰¯ã‹ã£ãŸ</li><ul><li>å–¶æ¥­æ™‚é–“å¤–ã®ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ã«å¯›å®¹</li></ul><li>å‹¢ã„ã‚‚å¤§äº‹</li><ul><li>ã€ŒDockerã‚„ã£ã¦ã„ããï¼ï¼ï¼ã€</li></ul></ul><br><small><p>ã‚‚ã£ã¨è©³ã—ã</p><ul><li><a href="http://blog.spicelife.jp/entry/2017/07/06/140349">Railsã‚¢ãƒ—ãƒªã‚’ECSã§é‹ç”¨ã™ã‚‹ã¾ã§ã«ã‚„ã£ãŸã“ã¨ã€ã“ã‚Œã‹ã‚‰ã—ã¦ã„ãã“ã¨</a></li><li><a href="http://blog.spicelife.jp/entry/2017/09/05/183605">ridgepoleã®applyã‚’ECS RunTaskã§å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸ</a></li></ul></small></section><section><h1 class="biggest">ã‚„ã‚Œã°<br>ã§ãã‚‹</h1></section></div></div><script src="lib/js/head.min.js"></script><script src="js/reveal.min.js"></script><script>// More info https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({
  history: true,
  transition: 'none',
  backgroundTransition: 'none',
  // More info https://github.com/hakimel/reveal.js#dependencies
  dependencies: [
    { src: 'plugin/markdown/marked.js' },
    { src: 'plugin/markdown/markdown.js' },
    { src: 'plugin/notes/notes.js', async: true },
    { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
  ]
});</script></body></html>