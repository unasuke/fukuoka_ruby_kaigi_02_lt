doctype html
html
  head
    meta(charset='utf-8')
    meta(name='viewport', content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no')
    title Ruby on Rails on ECS #fukuokark02
    link(rel='stylesheet', href='css/reveal.min.css')
    link(rel='stylesheet', href='css/theme/white.css')
    link(rel='stylesheet', href='lib/css/zenburn.css')
    link(rel='stylesheet', href='css/font-awesome.min.css')
    link(rel='stylesheet', href='css/my.css')
    script.
      var link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
      document.getElementsByTagName( 'head' )[0].appendChild( link );
    script(async='', src='//platform.twitter.com/widgets.js', charset='utf-8')
  body
    .reveal
      .slides
        section
          h1
            | Ruby on Rails on ECS
          p 2017-11-24
          p ç¦å²¡Rubyä¼šè­°02ãƒ»å‰å¤œç¥­
          p ã†ãªã™ã‘
        section
          h2 connpass
          img(src="img/connpass-long-title.png")
          small: a(href='https://fukuokarb.connpass.com/event/68497/') https://fukuokarb.connpass.com/event/68497/
          p ã‚¿ã‚¤ãƒˆãƒ«é•·éãã¾ã—ãŸ ğŸ™‡
        section
          p
            | æ–°è¦Railsã‚¢ãƒ—ãƒªã‚’ECSã§é‹ç”¨ã—ãŸã¨ãã®çŸ¥è¦‹ã‚„ã€
            br
            | ç¾è¡Œã®Railsã‚¢ãƒ—ãƒªã‚’DockeråŒ–ã™ã‚‹ã¨ãã«é­é‡ã—ãŸèª²é¡Œãªã©ã«ã¤ã„ã¦
          p æ”¹ã‚
          h2 Ruby on Rails on ECS
          img(src='img/connpass-atnd.png')
        section
          h2 è‡ªå·±ç´¹ä»‹
          .flex-container
            .item-40
              img(src='img/icon_raw.jpg' alt='icon')
            .item-60
              ul
                li åå‰: ã†ãªã™ã‘
                li æ ªå¼ä¼šç¤¾spice life
                li ã‚¤ãƒ³ãƒ•ãƒ©ãƒªãƒ¼ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢
                br
                li
                  | twitter&nbsp;
                  i.fa.fa-twitter
                  | :&nbsp;
                  a(href='https://twitter.com/yu_suke1994') @yu_suke1994
                li
                  | GitHub&nbsp;
                  i.fa.fa-github
                  | :&nbsp;
                  a(href='https://github.com/unasuke') @unasuke
        section
          h2 spice life
          .flex-container
            .item-50
              h3 TMIX
              img(src='img/tmix-lp.png' alt='TMIX')
            .item-50
              h3 STEERS
              img(src='img/steers-lp.png' alt='STEERS')
        section
          h2 ã‚‚ãã˜
          ol
            li æ–°è¦Railsã‚¢ãƒ—ãƒªã¨ã¯ â¬…ï¸â¬…ï¸â¬…ï¸
            li ã¾ãšã¯DockeråŒ–
            li ECSã§å‹•ã‹ã™
            li ãƒãƒã£ãŸã¨ã“ã‚
            li æ—¢å­˜ã®Railsã®ESCåŒ–ã®ãƒãƒ¼ãƒ‰ãƒ«
            li ã¾ã¨ã‚
        section
          h2 æ–°è¦Railsã‚¢ãƒ—ãƒª
          dl
            dt rails new
            dd 2017-04-10
            dt ç”¨é€”
            dd å¤§å£æ³¨æ–‡ã®ç¤¾å†…ç®¡ç†ç”¨
          p Docker(ECS)åŒ–ã™ã‚‹ã«ã¯ã‚‚ã£ã¦ã“ã„ã ã£ãŸ
        section
          h2 ã‚‚ãã˜
          ol
            li æ–°è¦Railsã‚¢ãƒ—ãƒªã¨ã¯
            li ã¾ãšã¯DockeråŒ– â¬…ï¸â¬…ï¸â¬…ï¸
            li ECSã§å‹•ã‹ã™
            li ãƒãƒã£ãŸã¨ã“ã‚
            li æ—¢å­˜ã®Railsã®ESCåŒ–ã®ãƒãƒ¼ãƒ‰ãƒ«
            li ã¾ã¨ã‚
        section
          h2 ã¾ãšã¯DockeråŒ–
          p ãªã‚“ã ã‹ã‚“ã ç’°å¢ƒã”ã¨ã«Dockerfileã¯ã‚ã‹ã‚Œã¡ã‚ƒã†
          pre
            code
              | app
              | config
              | db
              | docker/
              |   â”” app-base/
              |       â”” Dockerfile        # apt packages
              |   â”” app-development/
              |       â”” Dockerfile        # gem group :development
              |   â”” app-production/
              |       â”” Dockerfile        # gem group :production
        section
          h2 ã¾ãšã¯DockeråŒ–
          h3 asset precompile
          p Q. assetã©ã“ã«ç½®ãå•é¡Œ
          ul
            li S3ãªã©ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
            li ã‚³ãƒ³ãƒ†ãƒŠã®ä¸­
        section
          h2 ã¾ãšã¯DockeråŒ–
          h3 asset precompile
          h4 assetç½®ãå ´
          dl
            dt ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸
            dd ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ãŒè»½ããªã‚‹
            dt ã‚³ãƒ³ãƒ†ãƒŠã®ä¸­
            dd ãŠæ‰‹è»½
        section
          h2 ã¾ãšã¯DockeråŒ–
          h3 asset precompile
          h4 assetç½®ãå ´
          p ã‚³ãƒ³ãƒ†ãƒŠã®ä¸­ã«ç½®ãã“ã¨ã«ã—ãŸ
          p CDN â†’ nginx â†’ container
          small
            | å‚è€ƒ:
            a(href='http://r7kamura.hatenablog.com/entry/2016/12/26/041931')
              | amakanã®æœ¬ç•ªç’°å¢ƒã‚’Dockerã«ç§»è¡Œã—ãŸ - âœ˜â•¹â—¡â•¹âœ˜
        section
          h2 ã¾ãšã¯DockeråŒ–
          h3 assets in container
          p
            | asseté…ä¿¡ç”¨ãƒ‰ãƒ¡ã‚¤ãƒ³(CDN)ä»¥å¤–ã‹ã‚‰ã®
            br
            | assetã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’å¼¾ããŸã„
        section
          h2 ã¾ãšã¯DockeråŒ–
          h3 assets in container
          p nginx.confã§åˆ¶å¾¡
          table
            thead
              tr
                th path
                th asset.example.com
                th example.com
            tbody
              tr
                td
                  code /asset/*
                td 200
                td 200
              tr
                td
                  code /
                td 404
                td 200
        section
          h2 ã‚‚ãã˜
          ol
            li æ–°è¦Railsã‚¢ãƒ—ãƒªã¨ã¯
            li ã¾ãšã¯DockeråŒ–
            li ECSã§å‹•ã‹ã™ â¬…ï¸â¬…ï¸â¬…ï¸
            li ãƒãƒã£ãŸã¨ã“ã‚
            li æ—¢å­˜ã®Railsã®ESCåŒ–ã®ãƒãƒ¼ãƒ‰ãƒ«
            li ã¾ã¨ã‚
        section
          h2 ECSã§å‹•ã‹ã™
          h3 Docker imageã®build/push
          p ãªã‚‹ã¹ãé€Ÿãã™ã¾ã›ãŸã„
        section
          h2 ECSã§å‹•ã‹ã™
          h3 Docker imageã®build/push
          h4 æ¤œè¨¼ã—ãŸCI Service
          ul
            li Circle CI
            li Travis CI
            li Codeship
            li Codefresh
            li Drone.io
        section
          h2 ECSã§å‹•ã‹ã™
          h3 Docker imageã®build/push
          h4 Drone.ioã‚’é¸æŠ
          ul
            li ğŸ˜„ Docker layer cache
            li ğŸ˜„ Fast push to ECR (ã‚ªãƒ³ãƒ—ãƒ¬ãªã®ã§)
            li ğŸ˜„ Fast build (c4.large)
            li ğŸ˜£ ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹
            li ğŸ¤” OSS
        section
          h2 ECSã§å‹•ã‹ã™
          h3 Deploy
          ul
            li Service / Task Definition ã‚’ä¸€å…ƒç®¡ç†ã—ãŸã„
            li ç’°å¢ƒã‚’å•ã‚ãšãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
            li revisionã‚’ã‚«ãƒƒãƒãƒªæŒ‡å®šã—ãŸã„
        section
          h2 ECSã§å‹•ã‹ã™
          h3 Deploy
          h4 unasuke/mikoshi
          p: a(href='https://github.com/unasuke/mikoshi/') https://github.com/unasuke/mikoshi/
          p Service / Task Definitionã‚’Yaml(ERB)ã§ç®¡ç†ã™ã‚‹
          p å®šç¾©ã‚’å«ã‚€Docker imageã‚’ä½œæˆã—ã¦pull/deploy
        section
          h2 ECSã§å‹•ã‹ã™
          h3 Deploy
          h4 unasuke/mikoshi
          pre
            code.lang-yaml
              | # task_definitions/ping2googledns.yml.erb
              | task_definition:
              |   family: "ping2googledns"
              |   network_mode: "bridge"
              |   container_definitions:
              |     - name: "ping"
              |       image: "unasuke/ping2googledns:latest"
              |       cpu: 128
              |       memory: 128
              | hooks:
              |   after_register:
              |     - echo registerd
        section
          h2 ECSã§å‹•ã‹ã™
          h3 Deploy
          h4 unasuke/mikoshi
          p deploy command in CI job
          pre
            code
              | docker run --rm --tty \
              |   -e IMAGE_REVISION=${DRONE_COMMIT_SHA} \
              |   -e AWS_REGION=${AWS_DEFAULT_REGION} \
              |   ${ECR_HOST}/mikoshi-container:latest deploy -g app-name
        section
          h2 ã‚‚ãã˜
          ol
            li æ–°è¦Railsã‚¢ãƒ—ãƒªã¨ã¯
            li ã¾ãšã¯DockeråŒ–
            li ECSã§å‹•ã‹ã™
            li ãƒãƒã£ãŸã¨ã“ã‚  â¬…ï¸â¬…ï¸â¬…ï¸
            li æ—¢å­˜ã®Railsã®ESCåŒ–ã®ãƒãƒ¼ãƒ‰ãƒ«
            li ã¾ã¨ã‚
        section
          h2 ãƒãƒã£ãŸã¨ã“ã‚
          h3 db:migrate â†’ SIGTERM
          p ECS RunTaskã§ã®db:migrateãŒSIGTERM
        section
          h2 ãƒãƒã£ãŸã¨ã“ã‚
          h3 db:migrate â†’ SIGTERM
          h4 åŸå› 
          p
            | nginxã«trueã‚’æ¸¡ã—ã¦è½ã¨ã—ã¦ã„ãŸã®ãŒ
            br
            | ã¤ã‚‰ã‚Œã¦Railsã‚‚è½ã¡ã‚‹ ğŸ˜¨
        section
          h2 ãƒãƒã£ãŸã¨ã“ã‚
          h3 db:migrate â†’ SIGTERM
          h4 workaround
          p
            | Railsã®ã¿ã‚’å«ã‚€Task Definitionã‚’ä½œæˆã—ã¦
            br
            | ãã‚Œã‚’ä½¿ã„db:migrate
          p.fragment
            | ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”ğŸ¤”
        section
          h2 ãƒãƒã£ãŸã¨ã“ã‚
          h3 db:migrate â†’ SIGTERM
          h4 ä¾‹ãˆã°nginxã‚’ã‚„ã‚ã‚‹ï¼ï¼ï¼ï¼ï¼
        section
          h2 ãƒãƒã£ãŸã¨ã“ã‚
          h3 db:migrate â†’ SIGTERM
          h4 nginxã®å½¹å‰²
          ul
            li Basic Auth
              ul
                li Railsã§ã‚‚ã§ãã‚‹ï¼
            li httpsã¸ã®redirect
              ul
                li Railsã§ã‚‚ã§ãã‚‹ï¼
            li asseté…ä¿¡ã®ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ¶å¾¡
              ul
                li Railsã§ã‚‚â€¦â€¦ï¼Ÿ
        section
          h2 ãƒãƒã£ãŸã¨ã“ã‚
          h3 db:migrate â†’ SIGTERM
          h4 asseté…ä¿¡ã®ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ¶å¾¡ã‚’Rackã§
          p Rack middlewareã§ã‚„ã£ã¡ã‚ƒãˆã°ã„ã„ã‚“ã˜ã‚ƒï¼Ÿï¼
          ul
            li: a(href='https://github.com/udzura/rack-block') https://github.com/udzura/rack-block
            li: a(href='https://github.com/kickstarter/rack-attack') https://github.com/kickstarter/rack-attack
            ul
              li ã“ã£ã¡ã‚’æ¡ç”¨
        section
          h2 ãƒãƒã£ãŸã¨ã“ã‚
          h3 db:migrate â†’ SIGTERM
          h4 asseté…ä¿¡ã®ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ¶å¾¡ã‚’Rackã§
          p Rack middlewareã§ã‚„ã£ã¡ã‚ƒãˆã°ã„ã„ã‚“ã˜ã‚ƒï¼Ÿï¼
          img(src='img/tweet-yu_suke-1994-933349862862594048.png' width='45%')
          small
            | å›å&nbsp;
            a(href='https://twitter.com/yu_suke1994/status/933349862862594048') https://twitter.com/yu_suke1994/status/933349862862594048
        section
          h2 ãƒãƒã£ãŸã¨ã“ã‚
          ul
            li logã©ã†ã‚„ã£ã¦è¦‹ã‚‹ã®
            li rails consoleã—ãŸã„ã‚“ã ã‘ã©
          p æ™‚é–“ãªã„ã‚“ã§çœç•¥ ğŸƒğŸ’¨
        section
          h2 ã‚‚ãã˜
          ol
            li æ–°è¦Railsã‚¢ãƒ—ãƒªã¨ã¯
            li ã¾ãšã¯DockeråŒ–
            li ECSã§å‹•ã‹ã™
            li ãƒãƒã£ãŸã¨ã“ã‚
            li æ—¢å­˜ã®Railsã®ESCåŒ–ã®ãƒãƒ¼ãƒ‰ãƒ« â¬…ï¸â¬…ï¸â¬…ï¸
            li ã¾ã¨ã‚
        section
          h2 æ—¢å­˜ã®Railsã®ESCåŒ–ã®ãƒãƒ¼ãƒ‰ãƒ«
          p æ—¢å­˜ã®Railsã£ã¦ã„ã†ã®ã¯TMIXã®ã“ã¨ã§ã™
          small ã‚ãªãŸã¨JAVA
        section
          h2 TMIXã®ESCåŒ–ã®ãƒãƒ¼ãƒ‰ãƒ«
          ul
            li ridgepole
            ul
              li apply
              li test
        section
          h2 TMIXã®ESCåŒ–ã®ãƒãƒ¼ãƒ‰ãƒ«
          h3 ridgepole
          p
            | TMIXã¯1DBã€è¤‡æ•°App
            br
            | ridgepoleã§schemaç®¡ç†
          a(href='https://github.com/winebarrel/ridgepole') https://github.com/winebarrel/ridgepole
        section
          h2 TMIXã®ESCåŒ–ã®ãƒãƒ¼ãƒ‰ãƒ«
          h3 ridgepole
          h4 applyã‚’ã©ã†ã‚„ã£ã¦ã„ãŸã‹
          p
            | ridgepole applyã¯ã¨ã‚ã‚‹Railsã‚¢ãƒ—ãƒªã®
            br
            | ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‹ã‚‰capã§è¡Œãªã£ã¦ã„ãŸ
          p â¬†ï¸
          p ã‚³ãƒ³ãƒ†ãƒŠåŒ–ã™ã‚‹ã¨ãªã‚‹ã¨â€¦â€¦ï¼Ÿ
        section
          h2 TMIXã®ESCåŒ–ã®ãƒãƒ¼ãƒ‰ãƒ«
          h3 ridgepole
          h4 applyã‚’ã©ã†ã™ã‚‹ã‹
          p ECS RunTaskã§è¡Œãªã†(Done!)
          small ã“ã®ãŸã‚ã«mikoshiãŒRunTaskã«å¯¾å¿œã—ãŸ
        section
          h2 TMIXã®ESCåŒ–ã®ãƒãƒ¼ãƒ‰ãƒ«
          h3 test
          p
            | CIã§specã‚’å®Ÿè¡Œã™ã‚‹ã¨ãã«
            br
            | ã„ã¡ã„ã¡ridgepole applyã—ã¦ã„ã‚‹â€¦â€¦
          p â¬†ï¸
          p schemaé©ç”¨æ¸ˆã®DB containerã‚’ç”¨æ„ã§ããªã„ã‹ï¼Ÿ
          small æ‰‹ãŒã¤ã‘ã‚‰ã‚Œã¦ã„ãªã„â€¦â€¦
        section
          h2 TMIXã®ESCåŒ–ã®ãƒãƒ¼ãƒ‰ãƒ«
          h3 ã€Œã‚„ã£ã¦ã„ãã€ã®æ°—æŒã¡ ğŸ’ª
        section
          h2 ã‚‚ãã˜
          ol
            li æ–°è¦Railsã‚¢ãƒ—ãƒªã¨ã¯
            li ã¾ãšã¯DockeråŒ–
            li ECSã§å‹•ã‹ã™
            li ãƒãƒã£ãŸã¨ã“ã‚
            li æ—¢å­˜ã®Railsã®ESCåŒ–ã®ãƒãƒ¼ãƒ‰ãƒ«
            li ã¾ã¨ã‚ â¬…ï¸â¬…ï¸â¬…ï¸
        section
          h2 ã¾ã¨ã‚
          ul
            li ECSã§å‹•ã‹ã™ã‚ˆã‚Šã‚‚ã€ãã®å‰æº–å‚™ãŒå¤§å¤‰
            ul
              li CIã€deployã€æ§‹æˆetcâ€¦â€¦
            li ç¤¾å†…ã‚¢ãƒ—ãƒªã‹ã‚‰å°å…¥ã—ãŸã®ã¯è‰¯ã‹ã£ãŸ
            ul
              li å–¶æ¥­æ™‚é–“å¤–ã®ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ ã«å¯›å®¹
            li å‹¢ã„ã‚‚å¤§äº‹
            ul
              li ã€ŒDockerã‚„ã£ã¦ã„ããï¼ï¼ï¼ã€
          br
          small
            p ã‚‚ã£ã¨è©³ã—ã
            ul
              li: a(href='http://blog.spicelife.jp/entry/2017/07/06/140349') Railsã‚¢ãƒ—ãƒªã‚’ECSã§é‹ç”¨ã™ã‚‹ã¾ã§ã«ã‚„ã£ãŸã“ã¨ã€ã“ã‚Œã‹ã‚‰ã—ã¦ã„ãã“ã¨
              li: a(href='http://blog.spicelife.jp/entry/2017/09/05/183605') ridgepoleã®applyã‚’ECS RunTaskã§å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸ
        section
          h1.biggest
            | ã‚„ã‚Œã°
            br
            | ã§ãã‚‹
    script(src='lib/js/head.min.js')
    script(src='js/reveal.min.js')
    script.
      // More info https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        history: true,
        transition: 'none',
        backgroundTransition: 'none',
        // More info https://github.com/hakimel/reveal.js#dependencies
        dependencies: [
          { src: 'plugin/markdown/marked.js' },
          { src: 'plugin/markdown/markdown.js' },
          { src: 'plugin/notes/notes.js', async: true },
          { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } }
        ]
      });
